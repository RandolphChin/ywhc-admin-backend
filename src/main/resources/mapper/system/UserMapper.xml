<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ywhc.admin.modules.system.user.mapper.UserMapper">

    <!-- 根据用户名查询用户 -->
    <select id="selectByUsername" resultType="com.ywhc.admin.modules.system.user.entity.SysUser">
        SELECT sys_user.*,sys_dept.dept_name
        FROM sys_user sys_user LEFT JOIN sys_dept sys_dept
            on sys_user.dept_id=sys_dept.id
        WHERE sys_user.username = #{username} AND sys_user.deleted = 0
    </select>

    <!-- 根据用户ID查询用户权限 -->
    <select id="selectUserPermissions" resultType="string">
        SELECT DISTINCT m.permission
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        LEFT JOIN sys_role_menu rm ON r.id = rm.role_id
        LEFT JOIN sys_menu m ON rm.menu_id = m.id
        WHERE u.id = #{userId}
          AND u.deleted = 0
          AND u.status = 1
          AND r.deleted = 0
          AND r.status = 1
          AND m.deleted = 0
          AND m.status = 1
          AND m.permission IS NOT NULL
          AND m.permission != ''
    </select>

    <!-- 根据用户ID查询用户角色 -->
    <select id="selectUserRoles" resultType="string">
        SELECT DISTINCT r.role_key
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        WHERE u.id = #{userId}
          AND u.deleted = 0
          AND u.status = 1
          AND r.deleted = 0
          AND r.status = 1
    </select>

    <!-- 检查用户名是否存在 -->
    <select id="existsByUsername" resultType="boolean">
        SELECT COUNT(1) > 0 FROM sys_user
        WHERE username = #{username} AND deleted = 0
    </select>

    <!-- 检查邮箱是否存在 -->
    <select id="existsByEmail" resultType="boolean">
        SELECT COUNT(1) > 0 FROM sys_user
        WHERE email = #{email} AND deleted = 0
    </select>

    <!-- 检查手机号是否存在 -->
    <select id="existsByMobile" resultType="boolean">
        SELECT COUNT(1) > 0 FROM sys_user
        WHERE mobile = #{mobile} AND deleted = 0
    </select>

</mapper>
